format_version: 4
pipelines:
  PetClinic:
    group: sample
    label_template: ${COUNT}
    lock_behavior: none
    display_order: -1
    materials:
      git:
        git: https://github.com/dtsato/devops-in-practice-workshop.git
        shallow_clone: false
        auto_update: true
        branch: devops-east-19
    stages:
    - commit:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
        jobs:
          build-and-publish:
            timeout: 0
            environment_variables:
              MAVEN_OPTS: -Xmx1024m
              GCLOUD_PROJECT_ID: devops-workshop-123
            secure_variables:
              GCLOUD_SERVICE_KEY: AES:oQGIUduAoNb7nrjxSv8Ujg==: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
            elastic_profile_id: docker-jdk
            tasks:
            - exec:
                arguments:
                - clean package
                command: ./mvnw
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker build --tag pet-app:$GO_PIPELINE_LABEL --build-arg JAR_FILE=target/spring-petclinic-2.0.0.BUILD-SNAPSHOT.jar .
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker login -u _json_key -p"$(echo $GCLOUD_SERVICE_KEY | base64 -d)" https://us.gcr.io
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker tag pet-app:$GO_PIPELINE_LABEL us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker push us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
    - deploy:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
        jobs:
          deploy:
            timeout: 0
            environment_variables:
              GCLOUD_CLUSTER: devops-workshop-gke
              GCLOUD_ZONE: us-central1-a
              GCLOUD_PROJECT_ID: devops-workshop-123
            secure_variables:
              GCLOUD_SERVICE_KEY: AES:tsrHnyDIQ0VOhkybU5XCJg==:S5VF7YOn3AvOkk7jd454UocDrFwWwkKETCp1G9JcowrjL+VvCkk71xWcD2nYLfVIVVHtLH+Ltow0P0kLpXH429YXo4eNDUAn/q3+qX12HzWdj5i6J1iU8IgjH+ph5zvyjR8TBjP4L27QOFEcVZpITSx1GH+GPK6X7A1xEDeSu13Q1KWqqqnoZDSMVNMUBhlAMAt+fez+FASpl6fT7VeEHAML0i/mLhvL3MiXATx8deCt+xT1k+Pgaoyc9KwaaEJi9k+Y0BG1VVluCGS78UI0anTArq5CUx1msEHxBWaswD4Q/2pWHTR4hK5JwBFesONkSlrfSs9EGszy/Mh5i5Q2ML5CnH5sSKe6WbM61bmI7GgPtXexk0Eds/wYuAns6F2+BeBuh0yCzpxPaNHaL0D7HyVfilp99ajFDqj5xhJvVu5K/vXkJh5ngmpBRM8emGZz/0Yl6o9B9Uvr02jSvYa0H2FzsYLS7yyGiDwo3RAi6iQxtsLC5H/+wMpLhWuGU/3Wr8vX8H+0J8c8aMlWEeZQkuLWacb3o3m9UzuSS9PM1ytm2lVeqPY5TuEPPqtV4uHcvZoiInz23l7qsNR93xbd5OrhjHi64e8TOHsEdzID3XvL12hZzHOT+o2kkCApf0V3mbPO8p09uw1LNknZLUpfbzOAsjoC/bEa/bMTFN4D1JW2RX2xfXfVo9cV0vRWuC8lSXb+y2BFlEotwHBsNa/EsTDkCA3Cgk5KAvgzkHnDPdX73aDO2ecu0p+0z7pCNGAhbXZk0EgEMDWbgMK4TeOtTgX5lbz8Qmklp2zi29G5eLP2y0gYX4AyPAOIpxO5vanppMR+NYto0Uq161LhcyFsVwbKZHW0/qTdAvvUjUQ66/iz8RkTQxWQlYN3L9TqXJsxxKfGbLH1bPCjytW57hYg5JqJ4eLBUrpPRkYbC1DJNvzn4FJ7ghyLaCsSEY+5kNOuRbsg4Enw1xEyYTdh3jdkaPrdmrQvjQPG+S+7mADtDYW4aFmfFvgisZEUVNFDnoXQlPvAF5AYaQ9cIbY1kLNK5LTWudHClMmycEnpo3Odc6/owqHqox8Wdf+WJxFz/oryK+NRHZN8yxus4IWp63pBw7cSYccZGVNKRZhh2Ec74LOlxDObQFEM5iyGrQQXSrcxIpSQCWIvFkppOn3wXOHG62Ig/Suloew8iZ5lA/vyuc+x1dUU8pSiQeZozRPA5WAh5sutQzamtLORIZtKLsim/cUrOljTE0sYZk1Z0RYDhsF1mpDlsMVOSc1Lv6Ivx7jv4tT9uALNJT+VefCJd52XmAjTLAe/M6QlDdwGw9R19/WSTyq6IecmLFCpdswMfJDP3prsoMaUth31NpARLwqZHyPoh/C6Q4jK8yd8XvRDdJh5FS0HOg6CYEECBhb4gHf+6+RwDCE9its2UalMfg8ajIrI4Ihfee2M5FWv8bbQfH1905HXzHiIRhiixw8bUsjsCn+sHqmw9+1kEU6SuZ0KydDUrpac8pbE5OlFffF9vVRHOuylClfcuCWQ42xT4jozsVQIxAQVgTXcsZ7sYleWwe/YT4zjty4yfbvGPzfBoRBfzXVje40R6Y0iZtgX+ZQZmlfP0rY+d73g309/Oi7Vd29m2vk4QsUll7Ab3N6dh7diEC9jkN8+A5GCRdj3O4t30WIPMrcW56wQxDuGpQs+sYO5pFr+1wxv3GzjubqrXW9RGOu0mP1fYVIW+MsbFbMMN3MAEsmyXL+UcWZfsXOm1hl3+okJKE8KdBsck6Br0qnhUAz4Du4TSq5jF5sXSrBBkpPrlFq8SltUDIsFblZFNaU7e246xypLGs+fSh21TupV3XQCYs/bnYeC1G+hCZoaPiVP1nVmlk8pMaPKmFWt6PJghwEQmLZ5cyXt2lUTv2uolTMZcEpC7LqbtMLtJGN+tViWhIc7+suNjkWtIu1XJEw6OSpGLqa8wfscVwDgFCyCmyMnSyotfTmz7pRX62fgsavnvul2dgw6nVn3M7f8kosfS3ONzWRWzJcKzuyA+mwLaqn0TuhgvCos+Y8Oaz7EGyhrVUj7H7LI+66+a4aoqL9rcwSNXyUGP500PSpIiInAQRTNFEixRut6lxClOLFv0Z4v+D8tPNqStNhLdSXKeu4sD4O20e+TvwLE25So2tCsXQzACYdSgodKGitW+aZ8ypD2FIZoYxAYEo4VAlKc6jwFMcMQNPKkEgS5VoPffLfsAQpO0VyqxStQea6TFJIi+wRcgXC44eyL07qw7fjvmZmCTJvOAAMN+WBU0QmZgP4UlR/bUwzYbIodhatunedK7rYXL1+DtV1j/hXP18A+b4BG3MeAcasEN3ud0OL2QI9BT+swVsg4i0tpdtTx9hUdZiXjqqPIgrW1gxN2bFx3nKT0aa7Ar0MhPO8CBKpoavaao3IVhljnyM+kohcw1ziosfIwsGFzmPqo4Yb5Kr24dtVY6S6mJjqPfWq+kz+sb7jlSWJyZIQruKoezfCKZDabHFFgW8mNxozHOJhlUlNhhq68g5iuOfrTG1yUzpqKU7sw3WA3+MfxnFfPCawNxGshKJuisvsHzscv5pZsq5negBhrrZ2sGFLLSJdwrhFeLsvphd7zqFTgDWSwbV+K+aSPCzmlOzf3F9sM+wzWtS9SHSIicz9DhvR03RFHiYd7aapQhKXaRQvjKXYyhMwN7u+GicdGBMWayRCAoUj3w1bqVeUTPnuPkltdy2O9k6FlhNrkhlebDNMgtGOqTvRA+z3K+EmJR98kCAz2yZlhOyLkEEeSMpcE2NYrcK9UouZWgNoYw7axU5RVFK1yeF7IGoSh/9RbV4r4stfF0F0mXcx8UGoGJ/kPlrEWFWbVUY9l+N4Lbytzq8i7ZeVBVpH1y6OdMBVE+G0Fbr4Bl6uxOA2QkbgvQTJ5ctp6/VyRi4xMuGHVc3z4nHF5ZuRa6mULBl0UzGdSsonf3b34ji5YRTF67pe8EPZDKLGr4RCmBmbIJj60Qhj59j1Qi5E2NzkRvUvpeRXotF53+tduCugE4PkjzkjWGf+cAHWuYb4bBT+7z2rs2I3KoITib1fFKwRbZl50e1yTbVZEIcwfDOQxUp3Dek3sN5mOK1qmXvbdMEMJGrRY8wUqum1hVZHdaya4iVHkH+R1TQ8cS/HHtvKc6hQj0Wsst3d5nDAi32myOlrvyQ+tXK84gi0zCS5xW4v39f80rg5R6nIt+4Q2ZRlkWln0RseFxdMaT4vf8uUWu9HEmfCC1bEY1L40Z+mxt+bD1Zlv0IvXvQOjxpZ/eRqkumj/TOMPq8ldqETHRYCz+bTBV2DK0Tm9UzXVZ7JoB/wMgjkXLF2ByUeYUzJaG97FKu4wL9vqAYoURQgsolBteYW6CaLAA04JBswxEr5ma0Sr2N2ESYdE671vPugYEboVrKGztpvmpIetkHAELPvrTEjzEv7+Ef1Z9mynhWEPRBBXzWoATT50JKXtNKfZ5a1Uyd3BmArpTwreRY+V+kDFyH93zEZDId3jRkcNgnbAL0VMK+vURqnLlB97z7QtrKnOttWfHZrULdAXUWO8NBbYrZH0l1hSkNaIIjncCi4iowIFBpcA/ZubFX/fdlacqPILzS0VBvWde6QZ0ZfwMBtxgoUVK1omkdhAx7Ma6NCr8bQXO44PdcVzJqhpmlBukMEh5dH0DD07XpmOvpyiIj7E4twBOTKUeDf8CJ/aretRAhIHx1cWomytWC3oK41y+5hq46tyCC0yPDS6yOkAvBOwhxwiZjtvdM79RXE0BhEOXS5Ge05xIlpsMt3ZL8RAGnqZEugOjP6mJ0wHKNzD4zg6vrJDtD/uJ88sGH7xBw74nBWvkvQd7+SQxhtnjWoz/gcuZg9zYhEW2RdhsiOIickq34DZHLVpdnilgyl5nFqZFxfTC4Wqbm+CKhkjZCGtvP6XSL1eu9bck5GFBOKkifQuZqnK/C3GEwna/7eIymryBKbdBhJqwrzyBGl+pS4MGNwQavnDJNVsuYXq3RP2PGHZojkSvcyol2xv83pKSdwWn0YNypf71Gg1lMiAcp29kA6hFHbuZaPd36l5gH7G4JhphS25lp+JSAaDMMCSPadno5RefT2UaVlF5jsvG/c9XLeIyQgbF/ilYZS+Hnov6oHRtgOfrgwSWVv9eKyE1oxkpAXm1ncv
            elastic_profile_id: kubectl
            tasks:
            - exec:
                arguments:
                - -c
                - echo $GCLOUD_SERVICE_KEY | base64 -d > secret.json && chmod 600 secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud auth activate-service-account --key-file secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud container clusters get-credentials $GCLOUD_CLUSTER --zone $GCLOUD_ZONE --project $GCLOUD_PROJECT_ID
                command: bash
                run_if: passed
            - exec:
                command: ./deploy.sh
                run_if: passed
            - exec:
                arguments:
                - -c
                - rm secret.json
                command: bash
                run_if: passed
