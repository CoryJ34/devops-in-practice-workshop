format_version: 4
pipelines:
  PetClinic:
    group: sample
    label_template: ${COUNT}
    lock_behavior: none
    display_order: -1
    materials:
      git:
        git: https://github.com/dtsato/devops-in-practice-workshop.git
        shallow_clone: false
        auto_update: true
        branch: tw-may-19
    stages:
    - commit:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
        jobs:
          build-and-publish:
            timeout: 0
            environment_variables:
              MAVEN_OPTS: -Xmx1024m
              GCLOUD_PROJECT_ID: devops-workshop-123
            secure_variables:
              GCLOUD_SERVICE_KEY: AES:LEHXbZaCcJ0ZNoWNPVG+Gg==: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
            elastic_profile_id: docker-jdk
            tasks:
            - exec:
                arguments:
                - clean package
                command: ./mvnw
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker build --tag pet-app:$GO_PIPELINE_LABEL --build-arg JAR_FILE=target/spring-petclinic-2.0.0.BUILD-SNAPSHOT.jar .
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker login -u _json_key -p"$(echo $GCLOUD_SERVICE_KEY | base64 -d)" https://us.gcr.io
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker tag pet-app:$GO_PIPELINE_LABEL us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker push us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
    - deploy:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
        environment_variables:
          GCLOUD_CLUSTER: devops-workshop-gke
          GCLOUD_ZONE: us-central1-a
          GCLOUD_PROJECT_ID: devops-workshop-123
        secure_variables:
          GCLOUD_SERVICE_KEY: AES:n8pWAhVn76nTlediSJllDg==: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
        jobs:
          deploy:
            timeout: 0
            elastic_profile_id: kubectl
            tasks:
            - exec:
                arguments:
                - -c
                - echo $GCLOUD_SERVICE_KEY | base64 -d > secret.json && chmod 600 secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud auth activate-service-account --key-file secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud container clusters get-credentials $GCLOUD_CLUSTER --zone $GCLOUD_ZONE --project $GCLOUD_PROJECT_ID
                command: bash
                run_if: passed
            - exec:
                command: ./deploy.sh
                run_if: passed
            - exec:
                arguments:
                - -c
                - rm secret.json
                command: bash
                run_if: passed
