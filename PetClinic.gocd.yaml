format_version: 4
environments:
  gcp:
    environment_variables:
      GCLOUD_CLUSTER: devops-workshop-gke
      GCLOUD_ZONE: us-central1-a
      GCLOUD_PROJECT_ID: devops-workshop-123
    secure_variables:
      GCLOUD_SERVICE_KEY: AES:oQGIUduAoNb7nrjxSv8Ujg==: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
    pipelines:
      - PetClinic
pipelines:
  PetClinic:
    group: sample
    label_template: ${COUNT}
    lock_behavior: none
    display_order: -1
    materials:
      git:
        git: https://github.com/dtsato/devops-in-practice-workshop.git
        shallow_clone: false
        auto_update: true
        branch: devops-east-19
    stages:
    - commit:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
        jobs:
          build-and-publish:
            timeout: 0
            environment_variables:
              MAVEN_OPTS: -Xmx1024m
            elastic_profile_id: docker-jdk
            artifacts:
              - test:
                source: target/surefire-reports
            tasks:
            - exec:
                arguments:
                - clean package
                command: ./mvnw
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker build --tag pet-app:$GO_PIPELINE_LABEL --build-arg JAR_FILE=target/spring-petclinic-2.0.0.BUILD-SNAPSHOT.jar .
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker login -u _json_key -p"$(echo $GCLOUD_SERVICE_KEY | base64 -d)" https://us.gcr.io
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker tag pet-app:$GO_PIPELINE_LABEL us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker push us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
    - deploy:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
        jobs:
          deploy:
            timeout: 0
            elastic_profile_id: kubectl
            tasks:
            - exec:
                arguments:
                - -c
                - echo $GCLOUD_SERVICE_KEY | base64 -d > secret.json && chmod 600 secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud auth activate-service-account --key-file secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud container clusters get-credentials $GCLOUD_CLUSTER --zone $GCLOUD_ZONE --project $GCLOUD_PROJECT_ID
                command: bash
                run_if: passed
            - exec:
                command: ./deploy.sh
                run_if: passed
            - exec:
                arguments:
                - -c
                - rm secret.json
                command: bash
                run_if: passed
