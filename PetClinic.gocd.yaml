format_version: 4
environments:
  gcp:
    environment_variables:
      GCLOUD_CLUSTER: devops-workshop-gke
      GCLOUD_ZONE: us-central1-a
      GCLOUD_PROJECT_ID: devops-workshop-123
    secure_variables:
      GCLOUD_SERVICE_KEY: AES:xhEJxe7w+5iwOwpCMr8pkw==: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
    pipelines:
      - PetClinic
pipelines:
  PetClinic:
    group: sample
    label_template: ${COUNT}
    lock_behavior: none
    display_order: -1
    materials:
      git:
        git: https://github.com/dtsato/devops-in-practice-workshop.git
        shallow_clone: false
        auto_update: true
        branch: devops-west-19
    stages:
    - commit:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
        jobs:
          build-and-publish:
            timeout: 0
            environment_variables:
              MAVEN_OPTS: -Xmx1024m
            elastic_profile_id: docker-jdk
            artifacts:
              - test:
                  source: target/surefire-reports
            tasks:
            - exec:
                arguments:
                - clean package
                command: ./mvnw
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker build --tag pet-app:$GO_PIPELINE_LABEL --build-arg JAR_FILE=target/spring-petclinic-2.0.0.BUILD-SNAPSHOT.jar .
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker login -u _json_key -p"$(echo $GCLOUD_SERVICE_KEY | base64 -d)" https://us.gcr.io
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker tag pet-app:$GO_PIPELINE_LABEL us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - docker push us.gcr.io/$GCLOUD_PROJECT_ID/pet-app:$GO_PIPELINE_LABEL
                command: bash
                run_if: passed
    - deploy:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: success
        jobs:
          deploy:
            timeout: 0
            elastic_profile_id: kubectl
            tasks:
            - exec:
                arguments:
                - -c
                - echo $GCLOUD_SERVICE_KEY | base64 -d > secret.json && chmod 600 secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud auth activate-service-account --key-file secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud container clusters get-credentials $GCLOUD_CLUSTER --zone $GCLOUD_ZONE --project $GCLOUD_PROJECT_ID
                command: bash
                run_if: passed
            - exec:
                command: ./deploy.sh
                run_if: passed
            - exec:
                arguments:
                - -c
                - rm secret.json
                command: bash
                run_if: passed
    - approve-canary:
        fetch_materials: true
        keep_artifacts: false
        clean_workspace: false
        approval:
          type: manual
        jobs:
          complete-canary:
            timeout: 0
            elastic_profile_id: kubectl
            tasks:
            - exec:
                arguments:
                - -c
                - echo $GCLOUD_SERVICE_KEY | base64 -d > secret.json && chmod 600 secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud auth activate-service-account --key-file secret.json
                command: bash
                run_if: passed
            - exec:
                arguments:
                - -c
                - gcloud container clusters get-credentials $GCLOUD_CLUSTER --zone $GCLOUD_ZONE --project $GCLOUD_PROJECT_ID
                command: bash
                run_if: passed
            - exec:
                command: ./complete-canary.sh
                run_if: passed
            - exec:
                arguments:
                - -c
                - rm secret.json
                command: bash
                run_if: passed
